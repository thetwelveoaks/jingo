<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<title>Get Street</title>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=57xrHyB1Wj5mLxWgra9GTrBYtoSCvK9i"></script>
</head>
<body>
	
</body>
</html>
<script type="text/javascript">
	// 2896172
	var get_street = new XMLHttpRequest();
	var head = 3000000, tail = 3100000;
	var pool_size = 1000;

	decode_BDGPS();

	function geocodeSearch(point, index){
		var myGeo = new BMap.Geocoder();
		myGeo.getLocation(point, function(rs){
			var req_str = "id=" + index + "&street=" + rs.addressComponents.street;
			var update_street = new XMLHttpRequest();
			update_street.open("POST", "../php/writestreets.php", true);
			update_street.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			update_street.onreadystatechange = function() {
		      if (this.readyState == 4 && this.status == 200) {
		      	if(this.responseText != "1"){
		      		console.log(index + this.responseText);
		      	}
		      }
			};
			update_street.send(req_str);
		})
	}

	function decode_BDGPS(){
		var timeout;
		if(head + pool_size <= tail){
			timeout = setTimeout(window.decode_BDGPS, 30000);
		}
		var condition = "Street is null and DataUnitID >= " + head + " and DataUnitID < " + Math.min(head + pool_size, tail);
		get_street.open("POST", "../php/fetchBDGPS.php", true);
        get_street.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        var req_str = "condition=" + condition + "";
        get_street.send(req_str);

        get_street.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
          	var coords = JSON.parse(this.responseText);
          	if(coords.length == 0){
          		head += pool_size;
          		if(head < tail){
          			clearTimeout(timeout);
          			decode_BDGPS();
          		}
          	}
			for(var i = 0; i != coords.length; ++i){
				var point = new BMap.Point(coords[i].x, coords[i].y);
				geocodeSearch(point, coords[i].id);
			}
          }
        };
	}	
</script>
